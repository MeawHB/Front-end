<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="public/speex/bitstring.js"></script>
    <script src="public/speex/pcmdata.min.js"></script>
    <script src="public/speex/speex.js"></script>
    <script src="public/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" href="public/materialize/css/materialize.min.css">
    <!--先引用 不然页面会抖动-->
    <link rel="stylesheet" type="text/css" href="public/o8.css">
    <style>
        <!--
        右边滚动条显示-- >
        html {
            overflow-y: scroll;
        }

        * {
            padding: 0;
            margin: 0;
        }
    </style>
</head>
<body>

<nav>
    <div class="nav-wrapper blue-grey darken-1">
        <a href="#" class="brand-logo center">Logo</a>
        <ul id="nav-mobile" class="left hide-on-med-and-down">
            <li><a href="sass.html">Sass</a></li>
            <li><a href="badges.html">组件</a></li>
            <li><a href="collapsible.html">JavaScript</a></li>
        </ul>
    </div>
</nav>

<div class="row">
    <div class="col s1">
        <textarea id="left" rows="3"></textarea>
    </div>
</div>
<div class="row">
    <div class="col s6">
        <div class="card green lighten-4">
            <div class="card-content black-text">
                <div id="etext" class="col-lg-8 bg-success">英文文本</div>
            </div>
        </div>
    </div>
    <div class="col s4">
        <div class="card green lighten-4">
            <div class="card-content black-text">
                <div id="dict" class="col-lg-8 bg-success">英文文本</div>
            </div>
        </div>
    </div>
    <div class="col s2">
        <div class="card green lighten-4">
            <div class="card-content black-text">
                <div id="word" class="col-lg-8 bg-success">英文文本</div>
            </div>
        </div>
    </div>
</div>


<!--<div class="container">-->
<!--<div class="row">-->
<!--<div class="col-lg-3">-->
<!--<textarea id="left" rows="3"></textarea>-->
<!--</div>-->
<!--<div class="col-lg-3" style="display: none">-->
<!--<textarea id="right" rows="3"></textarea>-->
<!--</div>-->
<!--</div>-->
<!--<div class="row">-->
<!--<div id="etext1" class="col-lg-8 bg-success">英文文本</div>-->
<!--<div id="dict1" class="col-lg-4 bg-success">翻译解释</div>-->
<!--</div>-->
<!--</div>-->


<audio id="sound" width="200" autoplay="autoplay"></audio>
<script>
    //判断是否是标点
    function exist(char) {
        let biaodian = [' ', ',', '，', '.', '。', '\n', '"', '“', '?', , '？'];
        let flag = false;
        for (let i = 0; i < biaodian.length; i++) {
            if (char === biaodian[i]) {
                flag = true;
                break
            }
        }
        return flag
    }

    //textarea鼠标离开触发
    $("#left").on('mouseleave', function () {
        $("#etext").html("");
        let tmpText = $("#left").val();
        let word = '';
        for (let i = 0; i < tmpText.length; i++) {
            //如果发现标点，处理
            if (exist(tmpText[i])) {
                //单词加上<span>标签 方便后面mouseover获取
                if (word) {
                    $("#etext").append('<span>' + word + '</span>');
                    word = ''
                }
                //回车替换成</br> 其他标点原样添加
                if (tmpText[i] === '\n') {
                    $("#etext").append('<br>')
                } else {
                    $("#etext").append(tmpText[i])
                }
            } else {
                //没有标点，拼接单词
                word = word + tmpText[i];
                //如果最后不是标点，需要输出最后的单词
                if (i === (tmpText.length - 1) && word) {
                    $("#etext").append('<span>' + word + '</span>');
                }
            }
        }
        // $("#right").val($("#etext").html())
    });


    //鼠标移入 变色
    $("#etext").on('mouseover', 'span', function () {
        $(this).addClass('bg-primary');
        // $("#dict").text($(this).text())
        getDefinitions($(this).text())
    });

    //鼠标移出 恢复
    $("#etext").on('mouseleave', 'span', function () {
        $(this).removeClass('bg-primary');
    });

    //获取单词解释
    function getDefinitions(word) {
        $.ajax({
            type: "POST",
            url: '/word',
            data: {word: word},
            dataType: "json",
            success: function (result) {
                console.log('ajax----result: ', result);
                $("#dict").html(result.definitions);
                $("#word").html("");
                console.log(result.words);
                for (let i = 0; i < result.words.length; i++) {
                    $("#word").append('<p>' + (i + 1) + '. ' + result.words[i] + '</p>')
                }
            }
        })
    }

    //语音文件修标签 释义内跳转标签
    $("#dict").on('click', 'a', function (e) {
        e.preventDefault();
        console.log($(this).attr('href'));
        let href = $(this).attr('href');
        if (href.endsWith('.spx')) {
            getSpx(href)
        }
        if (href.startsWith('entry://')) {
            href = href.substring(8);
            getDefinitions(href)
        }
    });


    //spx buf 转 blob url
    /**
     * @param bufSpx ArrayBuffer (Uint8Array) holding content of speex file (*.spx or *.ogg)
     */
    function decodeFile(bufSpx) {
        var stream, samples, st;
        var ogg, header, err;

        ogg = new Ogg(bufSpx, {file: true});
        ogg.demux();
        stream = ogg.bitstream();

        header = Speex.parseHeader(ogg.frames[0]);
        console.log('header ', header);

        let comment = new SpeexComment(ogg.frames[1]);
        console.log('comment.data', comment.data);

        st = new Speex({
            quality: 8,
            mode: header.mode,
            rate: header.rate
        });

        samples = st.decode(stream, ogg.segments);

        var waveData = PCMData.encode({
            sampleRate: header.rate,
            channelCount: header.nb_channels,
            bytesPerSample: 2,
            data: samples
        });
        // return waveData
// array buffer holding audio data in wav codec
        var bufWav = Speex.util.str2ab(waveData);
// convert to a blob object
        var blob = new Blob([bufWav], {type: "audio/wav"});
// return a "blob://" url which can be used as a href anywhere
        return URL.createObjectURL(blob);
    }

    //获取spx文件并转换处理
    function getSpx(url) {
        $.ajax({
            type: "post",
            url: url,
            dataType: 'text',
            success: function (ogg) {
                //base64转回buf
                console.log('ogg', ogg);
                var buffer = atob(ogg);
                console.log('buffer', buffer);
                var decoded = decodeFile(buffer);
                console.log('decoded', decoded);
                console.log(decoded);
                $("#sound").attr("src", decoded);
            }
        })
    }


</script>
</body>
</html>