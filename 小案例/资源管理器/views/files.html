<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="../public/bootstrap.css">
    <script src="../public/jquery-3.3.1.js"></script>
</head>
<body>
<div>
    <div>
        <ol id="ol" class="breadcrumb">
            <!--<li><a href="#">Home</a></li>-->
            <!--<li><a href="#">Library</a></li>-->
            <!--<li class="active">Data</li>-->
        </ol>
    </div>
    <div>
        <table class="table table-hover">
            <thead>
            <tr>
                <!--<td class="col-md-2">文件名</td>-->
                <!--<td class="col-md-2">url路径</td>-->
                <!--<td class="col-md-2">服务器路径</td>-->
                <!--<td class="col-md-2">是否文件夹</td>-->
                <!--<td class="col-md-2">操作</td>-->
                <td>文件名</td>
                <td>url路径</td>
                <td>服务器路径</td>
                <td>是否文件夹</td>
                <td>操作</td>
            </tr>
            </thead>
            <tbody id="tbody">

            </tbody>
        </table>
    </div>
</div>
<script>
    var root_url = "/files";

    /**
     * list_url 目录树列表
     * temp_url 当前目录
     * list_length 目录树长度
     * muLuChuLi(url)  ajax访问url
     */
    var list_url = [];
    var temp_url = null;
    var list_length = 0;

    function muLuChuLi(url) {
        if (url === root_url) {
            list_url = [];
            temp_url = {url: url, parent_url: 0};
            list_url.push(temp_url);
        } else {
            // 如果当前列表存在要访问的url则切割；如果不存在则添加新的url
            let flag = false;
            $.each(list_url, function (index, item) {
                console.log('item.url:', item.url);
                console.log('url_path:', url);
                console.log('item.url === url:', item.url === url, 'index:', index);
                if (item.url === url) {
                    list_length = index;
                    flag = true;
                    return false;
                }
            });
            if (flag) {
                list_url = list_url.slice(0, list_length + 1);
            } else {
                temp_url = {url: url, parent_url: temp_url.url};
                list_url.push(temp_url);
            }
        }
        console.log('list_url:', list_url);
        $('#ol').empty();
        $.each(list_url, function (index, item) {
            let temp = item.url.split('/');
            temp = temp[temp.length - 1];
            $('#ol').append(`<li><a href="${item.url}" isdir=yes>${temp}</a></li>`)
        });
    }

    // result  ajax返回结果（json对象）
    function wenJianChuLi(result) {
        $('#tbody').empty();
        $.each(result, function (index, value) {
            trhtml = `<tr>
                            <td>${value.file_name}</td>
                            <td>${value.url_path}</td>
                            <td>${value.file_path}</a></td>
                            <td>${value.isDirectory}</td>`;
            if (value.isDirectory) {
                trhtml = trhtml + `<td><a href="${value.url_path}" isdir="yes">进入</a></td>
                                   <td><a href="${value.url_path}?download=yes" isdownload="yes" isdir="yes">下载</a></td></tr>`;
            } else {
                trhtml = trhtml + `<td></td><td><a href="${value.url_path}" isdir="no">下载</a></td></tr>`;
            }
            $('#tbody').append(trhtml);
        });
    }

    function getfilelist(url) {
        $.ajax({
            type: "GET",
            url,
            dataType: "json",
            success: function (result) {
                console.log('ajax----result: ', result);
                muLuChuLi(url);
                wenJianChuLi(result);
            }
        });
    }

    getfilelist(root_url);

    $('#tbody').on('click', 'a', function (e) {
        // let url_path = $(this).parent().parent().children().first().text();
        let url_path = $(this).attr("href");
        if ($(this).attr('isdir') === "yes") {
            if ($(this).attr('isdownload') === "yes") {
                //下载行为默认
            } else {
                e.preventDefault();
                getfilelist(url_path);
            }
        }
    });

    $('#ol').on('click', 'a', function (e) {
        e.preventDefault();
        let url_path = $(this).attr("href");
        getfilelist(url_path);
    })
</script>
</body>
</html>